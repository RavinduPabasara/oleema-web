{% extends "base.html" %}

{% block title %}Approve Overage - Oleema{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Approve Overage</h1>
                <p class="text-gray-600">Review and approve work log that creates an overage</p>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'success' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Warning Alert -->
    <div class="mb-8 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-red-500 mr-3 text-xl"></i>
            <div>
                <h3 class="text-lg font-medium text-red-800">Overage Detected</h3>
                <p class="text-red-700">{{ pending_work_log.overage_message }}</p>
            </div>
        </div>
    </div>

    <!-- Work Log Details -->
    <div class="card mb-8">
        <div class="card-header">
            <h3 class="card-title">Work Log Details</h3>
            <p class="card-subtitle">Review the work log that will create an overage</p>
        </div>
        
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-4">Work Log Information</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Employee:</span>
                            <span class="font-medium text-gray-900">{{ employee.name }} ({{ employee.employee_id }})</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Process:</span>
                            <span class="font-medium text-gray-900">{{ process.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Quantity:</span>
                            <span class="font-medium text-gray-900">{{ pending_work_log.quantity }} units</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-medium text-gray-900">{{ pending_work_log.date }}</span>
                        </div>
                        {% if pending_work_log.notes %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Notes:</span>
                            <span class="font-medium text-gray-900">{{ pending_work_log.notes }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-4">Order Information</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Order Number:</span>
                            <span class="font-medium text-gray-900">{{ order.order_no }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Order Date:</span>
                            <span class="font-medium text-gray-900">{{ order.date.strftime('%B %d, %Y') }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Color:</span>
                            <span class="font-medium text-gray-900">{{ order.color.replace('-', ' ').title() }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Size:</span>
                            <span class="font-medium text-gray-900">{{ order.size }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Order Quantity:</span>
                            <span class="font-medium text-gray-900">{{ order.quantity }} units</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Progress -->
    <div class="card mb-8">
        <div class="card-header">
            <h3 class="card-title">Current Progress</h3>
            <p class="card-subtitle">Current work log totals for this order and process</p>
        </div>
        
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-blue-600">Current Total</div>
                    <div class="text-lg font-semibold text-blue-900">
                        {{ (order.quantity - pending_work_log.quantity) if (order.quantity - pending_work_log.quantity) > 0 else 0 }} units
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-yellow-600">New Entry</div>
                    <div class="text-lg font-semibold text-yellow-900">{{ pending_work_log.quantity }} units</div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-red-600">After Addition</div>
                    <div class="text-lg font-semibold text-red-900">{{ order.quantity + pending_work_log.quantity }} units</div>
                </div>
            </div>
            
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        <span class="font-medium">Order Limit:</span> {{ order.quantity }} units
                    </div>
                    <div class="text-sm text-red-600">
                        <span class="font-medium">Overage:</span> {{ pending_work_log.quantity }} units
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Take Action</h3>
            <p class="card-subtitle">Choose how to proceed with this work log</p>
        </div>
        
        <div class="card-body">
            <form method="POST" action="{{ url_for('approve_overage') }}">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="submit" name="action" value="approve" id="approve-btn" class="btn btn-primary w-full">
                        <i class="fas fa-check mr-2"></i>
                        Approve & Create
                    </button>
                    
                    <button type="submit" name="action" value="edit" id="edit-btn" class="btn btn-secondary w-full">
                        <i class="fas fa-edit mr-2"></i>
                        Edit Quantity
                    </button>
                    
                    <button type="submit" name="action" value="cancel" id="cancel-btn" class="btn btn-danger w-full">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </button>
                </div>
                
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-yellow-500 mr-3 mt-1"></i>
                        <div class="text-sm text-yellow-700">
                            <p class="font-medium mb-1">Important Notes:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Approving will create the work log and track the overage</li>
                                <li>Editing will return you to the work log form to adjust the quantity</li>
                                <li>Cancelling will discard this work log entry</li>
                                <li>Overages can be resolved later from the Overage Management page</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manual form submission trigger
    const form = document.querySelector('form');
    const approveBtn = document.getElementById('approve-btn');
    const editBtn = document.getElementById('edit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    
    approveBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Approve overage submit button clicked!');
        console.log('Form data:', {
            action: 'approve'
        });
        
        // Set the action value
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'approve';
        form.appendChild(actionInput);
        
        // Manually trigger form submission
        console.log('Manually submitting approve overage form...');
        form.submit();
    });
    
    editBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Edit overage submit button clicked!');
        console.log('Form data:', {
            action: 'edit'
        });
        
        // Set the action value
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'edit';
        form.appendChild(actionInput);
        
        // Manually trigger form submission
        console.log('Manually submitting edit overage form...');
        form.submit();
    });
    
    cancelBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Cancel overage submit button clicked!');
        console.log('Form data:', {
            action: 'cancel'
        });
        
        // Set the action value
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'cancel';
        form.appendChild(actionInput);
        
        // Manually trigger form submission
        console.log('Manually submitting cancel overage form...');
        form.submit();
    });
});
</script>
{% endblock %} 
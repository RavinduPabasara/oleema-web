{% extends "base.html" %}

{% block title %}Edit Work Log - Oleema{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ url_for('work_logs') }}" class="text-primary hover:text-primary-dark mr-4">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">Edit Work Log</h1>
        </div>
        <p class="text-gray-600">Update work log entry details</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'success' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Work Log Form -->
    <div class="max-w-2xl">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Edit Work Log Entry</h3>
                <p class="card-subtitle">Update the work log information below</p>
            </div>
            
            <div class="card-body">
                <form method="POST" class="space-y-6">
                    <!-- Employee Selection -->
                    <div class="form-group">
                        <label for="employee_id" class="form-label">Employee *</label>
                        <select id="employee_id" name="employee_id" class="form-select" required>
                            <option value="" disabled>Select Employee</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}" {% if employee.id == work_log.employee_id %}selected{% endif %}>
                                {{ employee.name }} ({{ employee.employee_id }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Order Selection -->
                    <div class="form-group">
                        <label for="order_id" class="form-label">Order *</label>
                        <select id="order_id" name="order_id" class="form-select" required>
                            <option value="" disabled>Select Order</option>
                            {% for order in orders %}
                            <option value="{{ order.id }}" {% if order.id == work_log.order_id %}selected{% endif %}>
                                {{ order.order_no }} ({{ order.color }}, {{ order.size }}, Qty: {{ order.quantity }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Process Selection -->
                    <div class="form-group">
                        <label for="process_id" class="form-label">Process *</label>
                        <select id="process_id" name="process_id" class="form-select" required>
                            <option value="" disabled>Select Process</option>
                            {% for process in processes %}
                            <option value="{{ process.id }}" data-pay-rate="{{ process.pay_rate }}" {% if process.id == work_log.process_id %}selected{% endif %}>
                                {{ process.name }} (LKR {{ "%.2f"|format(process.pay_rate) }}/piece)
                            </option>
                            {% endfor %}
                        </select>
                        <p class="form-help">Select the manufacturing process performed</p>
                    </div>

                    <!-- Date Input -->
                    <div class="form-group">
                        <label for="date" class="form-label">Date *</label>
                        <input 
                            type="date" 
                            id="date" 
                            name="date" 
                            class="form-input" 
                            value="{{ work_log.date.strftime('%Y-%m-%d') }}"
                            required
                        >
                    </div>

                    <!-- Quantity Input -->
                    <div class="form-group">
                        <label for="quantity" class="form-label">Quantity (Pieces) *</label>
                        <input 
                            type="number" 
                            id="quantity" 
                            name="quantity" 
                            class="form-input" 
                            placeholder="Enter number of pieces"
                            value="{{ work_log.quantity }}"
                            min="1"
                            required
                        >
                        <p class="form-help">Number of pieces processed</p>
                    </div>

                    <!-- Payment Preview -->
                    <div class="form-group">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Payment Preview:</span>
                                <span class="text-lg font-bold text-primary" id="payment-preview">LKR {{ "%.2f"|format(work_log.quantity * work_log.process.pay_rate) }}</span>
                            </div>
                            <div class="text-xs text-gray-500" id="payment-breakdown">
                                {{ work_log.quantity }} pieces × LKR {{ "%.2f"|format(work_log.process.pay_rate) }} per piece
                            </div>
                        </div>
                    </div>

                    <!-- Notes Input -->
                    <div class="form-group">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea 
                            id="notes" 
                            name="notes" 
                            rows="3"
                            class="form-input" 
                            placeholder="Any additional notes or comments..."
                        >{{ work_log.notes or '' }}</textarea>
                        <p class="form-help">Optional: Add any special notes about this work</p>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="submit-btn" class="btn btn-primary btn-lg flex-1">
                            <i class="fas fa-save mr-2"></i>
                            Update Work Log
                        </button>
                        <a href="{{ url_for('work_logs') }}" class="btn btn-secondary btn-lg">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Payment calculation
    const quantityInput = document.getElementById('quantity');
    const processSelect = document.getElementById('process_id');
    const paymentPreview = document.getElementById('payment-preview');
    const paymentBreakdown = document.getElementById('payment-breakdown');
    
    function updatePaymentPreview() {
        const quantity = parseInt(quantityInput.value) || 0;
        const processOption = processSelect.options[processSelect.selectedIndex];
        
        if (processOption && processOption.value && quantity > 0) {
            const payRate = parseFloat(processOption.dataset.payRate);
            const payment = quantity * payRate;
            
            paymentPreview.textContent = `LKR ${payment.toFixed(2)}`;
            paymentBreakdown.textContent = `${quantity} pieces × LKR ${payRate.toFixed(2)} per piece`;
        } else {
            paymentPreview.textContent = 'LKR 0.00';
            paymentBreakdown.textContent = 'Select process and enter quantity to see payment';
        }
    }
    
    quantityInput.addEventListener('input', updatePaymentPreview);
    processSelect.addEventListener('change', updatePaymentPreview);
    
    // Initial calculation
    updatePaymentPreview();
    
    // Manual form submission trigger
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    
    submitBtn.addEventListener('click', function(e) {
        console.log('Edit work log submit button clicked!');
        console.log('Form data:', {
            employee_id: document.getElementById('employee_id').value,
            order_id: document.getElementById('order_id').value,
            process_id: document.getElementById('process_id').value,
            date: document.getElementById('date').value,
            quantity: document.getElementById('quantity').value,
            notes: document.getElementById('notes').value
        });
        
        // Manually trigger form submission
        console.log('Manually submitting edit work log form...');
        form.submit();
    });
});
</script>
{% endblock %} 